<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>RPG Developer NEXT 取扱説明書</title>
<link rel="stylesheet" type="text/css" href="css/reset.css">
<link rel="stylesheet" type="text/css" href="css/style.css">
<script src="js/jquery.min.js"></script>
<script src="js/script.js"></script>
<script src="js/auto-document.js"></script>
<script src="js/version-getter.js"></script>
</head>

<body class="node_game-knowledge">
<!-- タイトルバー -->
<div id="header">
  <a href="index.html"><h1><span>RPG Developer NEXT</span> <script>PrintVersion();</script> 取扱説明書</h1></a>
</div>

<div id="container">
<!-- 目次サイドバー -->
<div id="menuContainer">
  <div id="menuContent">
    <script src="js/manual-tree.js"></script>
    <script src="js/auto-tree.js"></script>
  </div>
</div>

<!-- メインコンテンツ -->
<div id="mainContainer">
  <!-- ぱんくずリスト [&gt]=[>] -->
  <div id="breadcrumb"><a href="index.html">HOME</a> &gt; <a href="game.html">ゲームプログラム部</a> &gt; 基本概念</div>

  <!-- 親ノード見出し -->
  <h2>基本概念</h2>
  <div class="text">
    <!-- 親ノードのテキスト -->
    <p>
      ゲームプログラムの根幹をなすシステムについて解説します。<br>
      スクリプトの組み込みオブジェクトはこの領域と連携しながら操作するものなので、スクリプトのコーディングを行う場合は一定の理解が求められます。<br>
      なお、全体的な構造としてオブジェクト指向的な特徴は少なく、実質的には分類分け程度に留まっています。<br>
    </p>
  </div>
  <hr>

  <!-- 子ノード見出し -->
  <h3 id="1">大まかな処理の流れ</h3>
  <div class="text">
    <!-- 子ノードのテキスト -->
    <div style="display: flex;">
      <div>
        <!-- 図：メインループ内の処理 -->
        <img src="img/frame.png" style="margin-right: 1rem;">
      </div>
      <div>
        <p>
          本ソフトはシングルスレッドで動作します。<br>
          左図のようなメインループを成し、この中で入力処理、描画処理、画面の更新を行います。<br>
          入力と描画はいずれもスクリプトにイベントハンドラーを呼び出す形で委託しています。<br>
          「画面の更新」とは、裏画面（オフスクリーンバッファ）に描画された内容を表画面（プライマリースクリーン）に切り替える処理のことです。<br>
          この処理によって「ちらつき現象」というものを防止しています。<br>
        </p>
      </div>
    </div>

    <h4>処理落ちについて</h4>
    <p>
      画面更新は1秒間に60回行われます。この画面更新1回分（厳密にはメインループ1周分）のことを 1フレーム と呼びます。<br>
      フレームレートで表すと、1秒間に60回の画面更新が行われるとき FPS=60 の状態で、この状態が基本となります。<br>
      しかし、1フレームあたりの処理が 1/60 秒 (0.0167 秒) よりも長引いてしまうと「フレーム遅延」が起こります。<br>
      これが「処理落ち」に相当し、フレームレートの値が下がります。<br>
      フレーム遅延が慢性的に起こっているときは、毎フレーム処理する部分のどこかに重たい処理が含まれている可能性があります。<br>
      このようなケースではプレイヤーにストレスを与えることになってしまうため、そのような重たい処理を解決するか、基本フレームレートを FPS=30 等に下げることで解決することになります。<br>
    </p>

    <h4>処理の待機について</h4>
    <p>
      入力処理の中では、プレイヤーの操作に応じて様々な処理を作っていくことになります。<br>
      マップのイベントは上図「並列処理」の中で行われます。<br>
      一定時間処理を停止したい場合は「ウェイト」という処理を使います。<br>
      ウェイト中は毎フレームで描画処理（必ず）と並列処理（任意）が行われますが、入力処理は行われません。<br>
      ただし、プレイヤーが入力しているキー情報の取得は内部的に毎フレームで行われています。<br>
    </p>

    <h4>シーンについて</h4>
    <p>
      ゲーム中は様々なシーン切り替えを行うことになります。<br>
      一般的なRPGでは大きく分けてタイトル画面とマップ画面に分けられますので、本ソフトでもこの2つをメインシーンとして定義しています。<br>
      シーンとして切り分けることの利点は、メインループの処理を変えることなくその時々に応じたシーンの描画や入力を行えるという点にあります。<br>
      しかし、切り分けているためにシーン間の相互のやり取りができません。<br>
      たとえば、タイトルシーンの中でマップを読み込んだり、イベントを起動したりすることはできません。<br>
      タイトル画面とマップ画面の2つだけをメインシーンとして扱っているのはこのためで、それ以外のシーンはどちらかのシーンの「サブシーン」として扱うことでメインシーンとサブシーンの間で相互のやり取りが可能となっています。<br>
    </p>
  </div>
  <hr>

  <!-- 子ノード見出し -->
  <h3 id="2">主要機能アクセスツリー</h3>
  <div class="text">
    <!-- 子ノードのテキスト -->
    <p>
      ゲームプログラム内で主要な機能のツリー構造を下図に示します。MGRは管理クラス (Manager) の略語です。<br>
      下図のように、ゲームMGRがすべての機能を包括しています。<br>
      スクリプトのコーディングを行うには、このツリー構造を把握していることが大前提となります。<br>
      テキストエディターのコマンドツリー「組み込みオブジェクト：変数」にあるノードが下図の構造に対応しています。<br>
    </p>

    <!-- 図：アクセスツリー -->
    <p>
      <img src="img/mgrtree.png" style="margin: 1rem;"><br>
    </p>

    <p>
      ※ カレントシーン … 現在のシーンオブジェクトが格納されるため、タイトルシーンとマップシーンが両立するのではなくどちらか一方のオブジェクトが格納されます。<br>
    </p>
  </div>
  <hr>

  <!-- 子ノード見出し -->
  <h3 id="3">フレームレートMGR</h3>
  <div class="text">
    <!-- 子ノードのテキスト -->
    <p>
      毎フレームの画面更新の際、スペックが高すぎる環境では1フレームあたりの時間が短くなりすぎてしまうことがあります。<br>
      この管理オブジェクトでは、1秒あたりのフレーム数を60になるように調整しながら画面更新を行います。<br>
      スペックが低い環境向けにフレームスキップを行う回数を指定しているときは、その回数分の画面更新をスキップします。<br>
      もっとも、画面更新自体に処理負荷はほとんどないためあまり効果は期待できません。<br>
    </p>
  </div>
  <hr>

  <!-- 子ノード見出し -->
  <h3 id="4">DXライブラリMGR</h3>
  <div class="text">
    <!-- 子ノードのテキスト -->
    <p>
      DXライブラリとは「DirectXを使ったWindowsソフトの開発に必ず付いて回るDirectXやWindows関連のプログラムを使い易くまとめた形で利用できるようにしたC++言語用のゲームライブラリ」です（DXライブラリ公式ページより引用）。<br>
      このライブラリには、グラフィックス描画、サウンド再生、キーボード・マウス・ジョイパッドの入力、ファイルの読み込み、ネットワーク通信等の機能が含まれており、本ソフトの実装上大きなウェイトを占める重要なライブラリです。<br>
      スクリプトでもこの機能が簡単に使えるように、ゲームMGRの中にラップする形で公開しています。<br>
      ゲーム全般で必要となる特に基本的かつ比較的低レイヤーな機能が提供されているため、使い方によってはRPGに限らず様々なジャンルのゲームを作ることも可能です。<br>
      スクリプトで独自システムを開発する場合は、この管理オブジェクトの活用が必須となります。<br>
    </p>
    <p>
      関数はラップする都合で機能を一部改変しているものを除いては元の関数名、元の引数リストの順序に合わせています。<br>
      DXライブラリ関数は数が多く細かい仕様もありますので、詳しい使用方法については <a href="https://dxlib.xsrv.jp/index.html" target="_blank">公式サイト</a> の <a href="https://dxlib.xsrv.jp/dxfunc.html" target="_blank">リファレンスマニュアル</a> をご覧下さい。
    </p>
  </div>
  <hr>

  <!-- 子ノード見出し -->
  <h3 id="5">疑似スレッドMGR</h3>
  <div class="text">
    <!-- 子ノードのテキスト -->
    <p>
      冒頭で述べたように、ゲームプログラムはシングルスレッドで動作するため、本来の意味でのマルチスレッドとは異なります（そのため「疑似」という名を冠しています）。<br>
      しかし、直列的かつ即時的に処理するのではなくある程度の時間をかけながら処理（バックグラウンド処理）を継続するようなケースは多々あります。<br>
      そこで、メインループのうち「並列処理」の中で毎フレーム行う処理を予約しておき、実行するための仕組みをこの管理オブジェクトに担わせています。<br>
      一般的な言語処理系にあるような「コルーチン」や「スレッド」とも厳密には異なりますが、用途としては近しい存在です。<br>
      並列的に実行したい関数に任意の名前を付けて、任意の変数（整数型、小数型、文字列型があります）を持たせて登録することで一意の識別番号を成すハンドル（整数値）を得ることができます。<br>
    </p>
    <p>
      並列実行する関数は明確にシグネチャーが決められており、整数型の引数を1つ持ち（疑似スレッドのハンドル）、論理型の値を返す必要があります。<br>
      この関数が true を返すとき、並列処理が完了したことを表し、破棄されて次のフレーム以降実行されなくなります。<br>
      また、疑似スレッドを一時停止したり、削除されないように保護することもできます。<br>
    </p>
  </div>
  <hr>

  <!-- 子ノード見出し -->
  <h3 id="6">データベース</h3>
  <div class="text">
    <!-- 子ノードのテキスト -->
    <p>
      エディター部で作られたデータベースの情報を操作するオブジェクトです。<br>
      エディター上ではあまり区別をしていない概念ですが、ゲームプログラム部では以下のような構造で厳密に区別されるようになります。<br>
    </p>

    <table>
      <tr>
        <th width="250">固定データベース / Fixed DB</th>
        <th width="250">可変データベース / Variable DB</th>
        <th width="250">ユーザーデータベース / User DB</th>
      </tr>

      <tr>
        <td>× セーブ対象とならない</td>
        <td>○ セーブ対象となる</td>
        <td>○ セーブ対象となる</td>
      </tr>

      <tr>
        <td style="vertical-align: top">
          <ul class="disc">
            <li>
              システム
              <ul class="circle">
                <li>データベース本体</li>
              </ul>
            </li>
            <li>
              初期設定
              <ul class="circle">
                <li>データベース本体</li>
              </ul>
            </li>
            <li>
              パーティキャラ
              <ul class="circle">
                <li>データベース本体</li>
              </ul>
            </li>
            <li>
              クラス
              <ul class="circle">
                <li>データベース本体</li>
              </ul>
            </li>
            <li>
              スキル
              <ul class="circle">
                <li>データベース本体</li>
              </ul>
            </li>
            <li>
              アイテム
              <ul class="circle">
                <li>データベース本体</li>
              </ul>
            </li>
            <li>
              間接効果
              <ul class="circle">
                <li>データベース本体</li>
              </ul>
            </li>
            <li>
              エネミー
              <ul class="circle">
                <li>データベース本体</li>
              </ul>
            </li>
            <li>
              ユニット
              <ul class="circle">
                <li>データベース本体</li>
              </ul>
            </li>
            <li>
              エフェクト
              <ul class="circle">
                <li>データベース本体</li>
              </ul>
            </li>
            <li>
              タイルセット
              <ul class="circle">
                <li>データベース本体</li>
              </ul>
            </li>
            <li>
              汎用素材
              <ul class="circle">
                <li>フェイスグラフィック</li>
                <li>グラフィック</li>
                <li>サウンド</li>
                <li>フォント</li>
              </ul>
            </li>
            <li>
              基本要素
              <ul class="circle">
                <li>パラメーター</li>
                <li>属性</li>
                <li>スキル種別</li>
                <li>アイテム大種別</li>
                <li>アイテム小種別</li>
              </ul>
            </li>
          </ul>
        </td>

        <td style="vertical-align: top">
          <ul class="disc">
            <li>
              変数/フラグ
              <ul class="circle">
                <li>共通フラグ</li>
                <li>共通整数</li>
                <li>共通文字変数</li>
                <li>アクター個別変数</li>
                <li>クラス個別変数</li>
                <li>アイテム/スキル個別変数</li>
                <li>間接効果個別変数</li>
                <li>ユニット個別変数</li>
                <li>イベント個別変数</li>
              </ul>
            </li>
            <li>
              パーティ情報<br>
              (初期設定DBから取り込まれる)
            </li>
            <li>
              アクター情報<br>
              (パーティキャラDBから取り込まれる)
            </li>
          </ul>
        </td>

        <td style="vertical-align: top">
          <ul class="disc">
            <li>
              ユーザーDB本体<br>
              (ユーザーDBのリスト情報)<br>
            </li>
            <li>各種ユーザーDBの単体DB</li>
          </ul>
        </td>
      </tr>
    </table>

    <p style="margin-top: 1rem;">
      各データベースの内部構造は次のようになっています。<br>
      セル値は型に対応する場所へ格納されます。<br>
      それ以外の型として取得しても空白に相当する値しか得られませんし、変更してもセーブデータとして反映されることはありません。<br>
    </p>
    <ul class="disc">
      <li>DB種別 (FDB/VDB/UDB)
        <ul class="disc">
          <li>親データベース
            <ul class="disc">
              <li>サブデータベース
                <ul class="disc">
                  <li>列名リスト</li>
                  <li>列型リスト</li>
                  <li>行リスト
                    <ul class="disc">
                      <li>
                        セルリスト
                        <ul class="disc">
                          <li>列型</li>
                          <li>セル値：文字列</li>
                          <li>セル値：論理値</li>
                          <li>セル値：単一値</li>
                          <li>セル値：複数値</li>
                          <li>セル値：IDと値のペアリスト</li>
                        </ul>
                      </li>
                    </ul>
                  </li>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </div>
  <hr>

  <!-- 子ノード見出し -->
  <h3 id="7">素材MGR</h3>
  <div class="text">
    <!-- 子ノードのテキスト -->
    <p>
      外部から読み込むリソースを管理するオブジェクトです。<br>
      読み込んだリソースはリストとして管理されるため、ゲーム終了時に一括で破棄する等といった処理が行われます。<br>
      リソースに対しては一意の識別番号（ハンドル）が与えられ、これを用いてグラフィックの描画、サウンドの再生、フォントの指定を行います。<br>
    </p>
    <p>
      汎用素材DBで定義された各種素材はこのオブジェクトを介して読み込まれます。<br>
      得られたハンドルは汎用素材DBの右端に新しい列（単一値）を追加して、ここに格納します。<br>
      汎用素材DBの管理オブジェクトでは、ハンドルを使うことなくFixedIDを使ってサウンドを再生する関数や、FixedIDからハンドル番号を取得する関数が用意されています。<br>
    </p>
  </div>
  <hr>

  <!-- 子ノード見出し -->
  <h3 id="8">スプライトMGR</h3>
  <div class="text">
    <!-- 子ノードのテキスト -->
    <p>
      一般的な「スプライト」とは機能が異なりますのでご注意下さい。<br>
      本ソフトにおけるスプライトは、ピクチャー表示に相当する機能を指します。<br>
      それぞれのスプライトに任意の識別番号を与えて、その番号を用いて操作を行います。<br>
    </p>
    <p>
      単体のスプライトで複数のグラフィック、複数のテキストを保持できるようにしています。<br>
      スプライトで使われるグラフィックは内部的には素材MGR上で管理されており、スプライトの追加と削除に合わせて自動的にリソースの管理が行われます。<br>
    </p>
    <p>
      スプライトの特徴として、拡張性のあるワイプ機能が挙げられます。<br>
      たとえばアドベンチャーゲームでよく使われる立ち絵を作る場合、表示と消去の演出を自由に作ることができます。<br>
    </p>
  </div>
  <hr>

  <!-- 子ノード見出し -->
  <h3 id="9">セーブデータMGR</h3>
  <div class="text">
    <!-- 子ノードのテキスト -->
    <p>
      ゲームの情報はすべてゲームMGRの中で管理されており、セーブデータMGRではこれらの情報をセーブデータとして読み書きする機能を提供します。<br>
      なお、セーブデータは暗号化処理が施されるため、編集者・プレイヤーともに中身を閲覧することはできません。<br>
      セーブデータに含まれる情報は以下の通りです。<br>
    </p>

    <ul class="disc">
      <li>ゲームのバージョン番号</li>
      <li>セーブ日時</li>
      <li>スクリプト定義によるヘッダー情報</li>
      <li>可変データベース</li>
      <li>ユーザーデータベース</li>
      <li>現在のマップ・イベント情報</li>
      <li>スクリプト定義による任意情報</li>
    </ul>

    <p style="margin-top: 1rem;">
      なお、途中に挟まるスクリプト定義のデータは実装上、すべて文字列として読み書きを行うことができ、暗号化および復号化の処理は隠蔽されています。<br>
    </p>
  </div>
  <hr>

  <!-- 子ノード見出し -->
  <h3 id="10">カレントシーン</h3>
  <div class="text">
    <!-- 子ノードのテキスト -->
    <p>
      その時点で有効なシーンオブジェクトです。<br>
      シーン内のBGM/BGSオブジェクトもこの中に含まれます。<br>
      シーンが有効であるときに限り、そのシーンの描画と入力の処理が毎フレーム呼ばれます。<br>
    </p>
    <p>
      シーンに入るときに初期化の処理が、シーンから出るときに破棄の処理が呼び出されます。<br>
      よって、｛マップ→タイトル→マップ｝と他のシーンを挟んでからシーンを戻したとしても、戻ったシーンの情報はすべて初期化された状態となります。<br>
    </p>
  </div>
  <hr>
</div><!-- /#mainContainer -->
</div><!-- /#container -->
</body>
</html>
